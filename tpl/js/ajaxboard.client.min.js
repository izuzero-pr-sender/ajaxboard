/**
 * AJAXBoard XE Module Javascript
 * Copyright (C) 아약스보드. All rights reserved.
 **/
!function(e){AJAXBoard=xe.createApp("AJAXBoard",{init:function(e,t,r){this.request_uri=e,this.current_url=t,this.current_mid=r,this.timeout=1e3,this.triggers={before:[],after:[]}},connect:function(){if(!this.token||!this.server_uri)return this;var e=buildQuery({token:this.token,mid:this.current_mid,member_srl:this.member_srl});return this.socket=io(this.server_uri,{query:e,reconnectionAttempts:10}),this.bindListeners()},bindListeners:function(){if(!this.socket)return this;var e=this;return this.socket.on("notice",function(t){e.triggerCall("events.notice","before",[t])}),this.socket.on("noticeOfServer",function(t){e.triggerCall("events.noticeOfServer","before",[t])}),this.socket.on("insertDocument",function(t){var r=e.getDocumentHandler(t);r.done(function(t){!e.notify_list[t.module_srl]||e.member_srl&&e.member_srl==t.member_srl||e.triggerCall("events.notifyDocument","before",[t.document_srl,t.title,t.content,t.nickname]),e.triggerCall("events.insertDocument","before",[t.document_srl])})}),this.socket.on("deleteDocument",function(t){e.triggerCall("events.deleteDocument","before",[t])}),this.socket.on("documentVoteUp",function(t){var r=e.getDocumentHandler(t);r.done(function(t){e.triggerCall("events.documentVoteUp","before",[t.document_srl,t.voted_count])})}),this.socket.on("documentVoteDown",function(t){var r=e.getDocumentHandler(t);r.done(function(t){e.triggerCall("events.documentVoteDown","before",[t.document_srl,t.blamed_count])})}),this.socket.on("insertComment",function(t){var r=e.getCommentHandler(t);r.done(function(t){(!e.member_srl||e.member_srl!=t.parent_srl&&e.member_srl!=t.member_srl)&&e.triggerCall("events.notifyComment","before",[t.document_srl,t.comment_srl,t.content,t.nickname]),e.triggerCall("events.insertComment","before",[t.document_srl,t.comment_srl])})}),this.socket.on("deleteComment",function(t){e.triggerCall("events.deleteComment","before",[t])}),this.socket.on("commentVoteUp",function(t){var r=e.getCommentHandler(t);r.done(function(t){e.triggerCall("events.commentVoteUp","before",[t.document_srl,t.comment_srl,t.voted_count])})}),this.socket.on("commentVoteDown",function(t){var r=e.getCommentHandler(t);r.done(function(t){e.triggerCall("events.commentVoteDown","before",[t.document_srl,t.comment_srl,t.blamed_count])})}),this.socket.on("connect",function(){e.triggerCall("events.connect","after")}),this.socket.on("error",function(e){try{console.error("Unable to socket.io: %s",e)}catch(t){}}),this},insertTrigger:function(t,r,n){if(e.isArray(this.triggers[r])){var o={name:t,callback:n};this.triggers[r].push(o)}return this},getTriggers:function(t,r){var n=new Array;if(!e.isArray(this.triggers[r]))return n;this.triggers[r].sort(function(e,r){return e.name==r.name?0:r.name==t?1:-1});for(var o in this.triggers[r]){var i=this.triggers[r][o];if(i.name!=t)break;n.push(i.callback)}return n},triggerCall:function(t,r,n){var o=this.getTriggers(t,r);for(var i in o){var s=o[i];e.isFunction(s)&&s.apply(this,n||[])}return this},procAjax:function(t,r,n,o,i,s){this.triggerCall("procAjax","before",[t,r,n,o,i,s]),i=i?i.toUpperCase():i="GET",s=s?s.toLowerCase():s="html";var a;switch(s){case"html":a="text/html";break;case"json":case"jsonp":a="application/json";break;case"xml":a="application/xml";break;default:a="text/plain"}return o=e.isPlainObject(o)?o:{},o.mid=this.current_mid,r&&(o.module=r),n&&(o.act=n),o={url:t,type:i,dataType:s,contentType:a,data:o,global:!1,timeout:this.timeout},this.triggerCall("procAjax","after",[o]),e.ajax(o)},startAjax:function(){this.triggerCall("startAjax","before");var t=e(".wfsr");if(this.use_wfsr&&show_waiting_message&&t.length){var r=t.data("timeout_id");r&&clearTimeout(r),t.css("opacity","").html(waiting_message).show()}return this.triggerCall("startAjax","after"),this},stopAjax:function(){this.triggerCall("stopAjax","before");var t=e(".wfsr");return this.use_wfsr&&show_waiting_message&&t.length&&t.hide().css("opacity",0),this.triggerCall("stopAjax","after"),this},getPagesHandler:function(e){return this.procAjax(this.current_url,null,null,e,"GET","html")},getWholeVariablesHandler:function(){return this.procAjax(this.current_url,"ajaxboard","getAjaxboardWholeVariables",{mid:this.current_mid},"POST","json")},getDocumentHandler:function(e){return this.procAjax(this.current_url,"ajaxboard","getAjaxboardDocument",{document_srl:e},"POST","json")},getCommentHandler:function(e){return this.procAjax(this.current_url,"ajaxboard","getAjaxboardComment",{comment_srl:e},"POST","json")},setWholeVariables:function(){var t=this,r=this.getWholeVariablesHandler();return r.done(function(r){e.extend(xe.lang,r.lang),t.module_path=r.module_path,t.module_srl=r.module_srl,t.member_srl=r.member_srl,t.document_srl=r.document_srl,t.notify_list=r.notify_list,t.use_wfsr="Y"==r.use_wfsr?!0:!1,t.timeout=r.timeout,t.token=r.token,t.server_uri=r.server_uri,t.skin_info=r.skin_info}).fail(function(e,t,r){try{console.error("%s: %s, %o",t,r,e)}catch(n){}}),r},deleteComment:function(e,t){this.startAjax();var r=this,n=this.getCommentHandler(t);return n.done(function(n){if(n.is_granted){if(confirm(xe.lang.msg_delete_comment)){var o={mid:r.current_mid,comment_srl:t};exec_xml("board","procBoardDeleteComment",o,completeDeleteComment,["error","message","mid","document_srl","page"])}}else confirm(xe.lang.msg_password_required)&&(location.href=e)}).fail(function(e,t,r){try{console.error("%s: %s, %o",t,r,e)}catch(n){}}).always(function(){r.stopAjax()}),this},clearCommentEditor:function(){if(e("input[name='comment_srl']").val(""),e("div.xpress-editor").length){var t=e("div.xpress_xeditor_editing_area_container").attr("id").split("-")[3],r=e("#uploaded_file_list_"+t+" option"),n=e("#preview_uploaded_"+t);e("#editor_iframe_"+t).contents().find("body").html(""),r.length&&(uploadedFiles=new Array,r.remove(),n.empty(),uploaderSettings[t].uploadTargetSrl="")}return e("div.xeTextEditor").length&&e("div.xeTextEditor textarea").val(""),e("div.textyleEditor button.del").trigger("click"),this.triggerCall("clearCommentEditor","after"),this},scrollToComment:function(t,r,n){var o,i=e(n);if(!i.length)return this;switch(t){case 1:o=i.offset().top;break;case 2:o=i.offset().top+i.outerHeight()-e(window).height()/2;break;case 3:o=i.offset().top+i.outerHeight();break;default:try{console.error("error: Invalid type.")}catch(s){}return this}return e("html,body").stop().animate({scrollTop:o},1e3*r,"easeInOutExpo"),this}})}(jQuery),jQuery(function(){oAJAXBoard=new AJAXBoard(request_uri,current_url,current_mid),xe.registerApp(oAJAXBoard)});